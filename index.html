<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dulce Pesadilla Navideña</title>
    <style>
        /* ESTILOS GENERALES */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: #050505; color: white; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #game-container { width: 100%; max-width: 450px; height: 100%; position: relative; background-color: #000; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        
        /* PANTALLA DE INICIO */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #2a0000 0%, #000000 90%);
            z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 40px; text-align: center;
        }
        .title { 
            color: #ff0000; font-size: 2.6em; margin-bottom: 20px; 
            text-transform: uppercase; letter-spacing: 3px; font-weight: 900; 
            text-shadow: 0 0 10px #ff0000, 0 0 20px #8b0000;
            animation: latido 2s infinite ease-in-out;
        }
        @keyframes latido {
            0% { transform: scale(1); text-shadow: 0 0 10px #ff0000; }
            50% { transform: scale(1.05); text-shadow: 0 0 25px #ff3333, 0 0 15px #ff0000; }
            100% { transform: scale(1); text-shadow: 0 0 10px #ff0000; }
        }
        .subtitle { color: #aaa; margin-bottom: 50px; font-size: 1.1em; letter-spacing: 1px; }
        input[type="text"] { background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 15px; font-size: 1.1em; border-radius: 8px; width: 100%; text-align: center; margin-bottom: 20px; outline: none; transition: 0.3s; }
        input:focus { border-color: #ff0000; background: rgba(255,255,255,0.15); }
        .btn-start { background: linear-gradient(135deg, #cc0000, #ff0000); border: none; padding: 15px; width: 100%; color: white; font-weight: bold; font-size: 1.2em; border-radius: 8px; cursor: pointer; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4); }

        /* CAPAS DE JUEGO */
        .scene-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; background-repeat: no-repeat; z-index: 1; }
        #scene-layer-front { z-index: 2; opacity: 0; transition: opacity 0.6s ease-in-out; }
        .fade-in { opacity: 1 !important; }

        /* INTERFAZ */
        #ui-layer { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; pointer-events: none; background: linear-gradient(to top, rgba(0,0,0,0.9) 10%, transparent 40%); }
        .interactive { pointer-events: auto; }
        .text-box { background: rgba(10, 10, 10, 0.9); width: 100%; padding: 20px 20px 35px 20px; border-radius: 12px; border: 1px solid #333; min-height: 140px; display: flex; flex-direction: column; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .name-tag { font-weight: 700; color: #ff4d4d; margin-bottom: 12px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1.5px; }
        .dialogue { font-size: 1.15em; line-height: 1.6; color: #e0e0e0; margin-bottom: 10px; }
        .next-arrow { position: absolute; bottom: 15px; right: 20px; color: #888; font-size: 1.8em; cursor: pointer; animation: bounce 1s infinite; opacity: 0.8; transition: 0.3s; }
        .next-arrow:hover { color: white; opacity: 1; }

        /* BOTONES */
        .choices-container { display: flex; flex-direction: column; gap: 12px; width: 100%; margin-bottom: 20px; }
        .btn { padding: 16px; border-radius: 10px; border: 1px solid #444; cursor: pointer; font-size: 1.05em; font-weight: 600; text-align: center; width: 100%; background: linear-gradient(to bottom, #2a2a2a, #1a1a1a); color: #ddd; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn:active { background: #111; transform: translateY(2px); box-shadow: none; }
        .hidden { display: none !important; }
        
        /* EFECTOS */
        .shake { animation: shake 0.5s; }
        .red-flash { position: absolute; top:0; left:0; width:100%; height:100%; background: red; opacity: 0; pointer-events: none; z-index: 20; transition: opacity 0.2s; }
        .flash-active { opacity: 0.5 !important; }
        .bobbing { animation: bob 2s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 25% { transform: translate(-2px, -2px); } 50% { transform: translate(2px, 2px); } 75% { transform: translate(-1px, -1px); } }
        @keyframes bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen">
        <div class="title">DULCE PESADILLA<br>NAVIDEÑA</div>
        <div class="subtitle">Especial de Navidad</div>
        <input type="text" id="player-name-input" placeholder="Escribe tu nombre..." maxlength="12">
        <button id="start-btn" class="btn-start">COMENZAR</button>
    </div>

    <div id="scene-layer-back" class="scene-layer"></div>
    <div id="scene-layer-front" class="scene-layer"></div>
    <div id="flash-overlay" class="red-flash"></div>

    <div id="ui-layer">
        <div id="choices-area" class="choices-container interactive hidden"></div>
        <div id="text-area" class="text-box interactive hidden">
            <div id="char-name" class="name-tag"></div>
            <div id="dialogue-text" class="dialogue"></div>
            <div id="next-btn" class="next-arrow">▼</div>
        </div>
    </div>
</div>

<script>
    const BG_NEGRO = '#000';
    const SALA_LUZ = 'sala_luz.jpg';
    const SALA_NO_LUZ = 'sala_no_luz.jpg';
    const CUARTO_NOCHE = 'cuarto_noche.jpg';
    const PANTALLA_MUERTE = 'pantalla_muerte.jpg';
    const PUERTA_SALIR = 'puerta_salir.jpg';
    const JOHN_SALA = 'santa_sala.jpg';
    const JOHN_ASESINO = 'santa_cara_asesino.jpg';
    const JOHN_RIE = 'santa_rie.jpg';
    const JOHN_CUARTO = 'santa_cuarto.jpg';
    const JOHN_DESVISTE = 'santa_desviste.jpg';
    const JOHN_CERCA = 'santa_cerca.jpg';
    const JOHN_MANO = 'santa_mano.jpg';
    const LEVANTA_PIERNA = 'levanta_pierna.jpg';
    const BESO_PIERNA = 'beso_pierna.jpg';
    const CAMA_ABAJO = 'santa_cama_abajo.jpg';
    const CUARTO_REVUELTO = 'cuarto_revuelto.jpg';
    const NOTA_FINAL = 'mensaje_final.jpg';

    /* HISTORIA */
    const story = {
        "start": { img: BG_NEGRO, text: "Dicen que la Navidad es la época más mágica del año...", name: "Tú", next: "i2" },
        "i2": { img: BG_NEGRO, text: "Risas, familia, regalos bajo el árbol.", name: "Tú", next: "i3" },
        "i3": { img: BG_NEGRO, text: "Pero para mí... es solo otra noche de silencio ensordecedor.", name: "Tú", next: "s1" },
        "s1": { img: SALA_LUZ, text: "Llegué del trabajo arrastrando los pies. El frío se me ha metido hasta los huesos", name: "Tú", next: "s2" },
        "s2": { img: SALA_LUZ, text: "Mira este lugar... Lleno de luces y adornos.", name: "Tú", next: "s3" },
        "s3": { img: SALA_LUZ, text: "¿Para qué me molesté en decorar si vivo sola? Supongo que es la costumbre.", name: "Tú", next: "s4" },
        "s4": { img: SALA_LUZ, text: "Haa... Es irónico...", name: "Tú", next: "s5" },
        "s5": { img: SALA_LUZ, text: "De pequeña, solía esconderme detrás de este mismo sofá.", name: "Tú", next: "s6" },
        "s6": { img: SALA_LUZ, text: "Aguantaba la respiración, esperando ver a Santa Claus bajar por la chimenea.", name: "Tú", next: "s7" },
        "s7": { img: SALA_LUZ, text: "Nunca lo vi. El sueño siempre me vencía antes de medianoche.", name: "Tú", next: "s8" },
        "s8": { img: SALA_LUZ, text: "Cosas de niños ingenuos. Los milagros no bajan por la chimenea. En la vida real, si alguien entra en tu casa a medianoche...", name: "Tú", next: "s9" },
        "s9": { img: SALA_LUZ, text: "...probablemente no venga a dejar regalos.", name: "Tú", effect: "flash", next: "s10" },
        "s10": { img: SALA_LUZ, text: "Basta de melancolía. Mañana será otro día.", name: "Tú", next: "s11" },
        "s11": { img: SALA_LUZ, text: "Apagaré todo y me iré a la cama.", name: "Tú", next: "snl" },
        "snl": { img: SALA_NO_LUZ, text: "Solo quiero dormir y olvidar que es Navidad.", name: "Tú", next: "cn1" },
        "cn1": { img: CUARTO_NOCHE, text: "Me preparaba para dormir cuando...", name: "Tú", next: "crash" },
        "crash": { img: CUARTO_NOCHE, sound: "shake", text: "CRASH", name: "Sonido", next: "cn2" },
        "cn2": { img: CUARTO_NOCHE, text: "¿Qué...? ¿Qué fue eso?", name: "Tú", next: "cn3" },
        "cn3": { img: CUARTO_NOCHE, text: "Juraría que cerré la puerta con llave.", name: "Tú", choices: [{ text: "Tengo mucho miedo... mejor me escondo bajo las sábanas y finjo dormir.", target: "ra1" }, { text: "No voy a ser una víctima. Voy a la sala a investigar.", target: "rb1" }] },
        
        "ra1": { img: BG_NEGRO, text: "No... no quiero ver. Si no me muevo, quizás se vaya.", name: "Tú", next: "ra2" },
        "ra2": { img: BG_NEGRO, text: "Cierro los ojos con fuerza. Mi corazón late tan fuerte que me duele el pecho.", name: "Tú", next: "ra3" },
        "ra3": { img: BG_NEGRO, text: "Escucho pasos. Pesados. Lentos. Se acercan a la cama...", name: "Tú", next: "ra4" },
        "ra4": { img: BG_NEGRO, text: "Se detienen justo a mi lado.", name: "Tú", next: "ra5" },
        "ra5": { img: BG_NEGRO, text: "Por favor, que sea un sueño, por favor...", name: "Tú", next: "voz" },
        "voz": { img: BG_NEGRO, text: "– Te encontré...", name: "Voz Desconocida", sound: "shake", next: "m1" },
        "m1": { img: PANTALLA_MUERTE, text: "Ni siquiera me dio tiempo a gritar...", name: "Tú", next: "m2" },
        "m2": { img: PANTALLA_MUERTE, text: "Sentí un estallido de dolor en la cabeza... frío... y luego nada.", name: "Tú", next: "fm1" },
        "fm1": { img: BG_NEGRO, text: "[FINAL MALO 1: Muerte entre sábanas]", name: "GAME OVER", restart: true },

        "rb1": { img: SALA_NO_LUZ, text: "Me armé de valor y salí.", name: "Tú", next: "js1" },
        "js1": { img: JOHN_SALA, text: "Allí estaba él. Un hombre alto... ¿vestido de Santa Claus?", name: "Tú", next: "js2" },
        "js2": { img: JOHN_SALA, text: "Pero... espera.", name: "Tú", next: "js3" },
        "js3": { img: JOHN_SALA, text: "Esa sonrisa... Esa mirada roja y fría...", name: "Tú", next: "js4" },
        "js4": { img: JOHN_SALA, text: "Mi sangre se hiela. Lo he visto en las noticias esta mañana mientras tomaba café.", name: "Tú", next: "js5" },
        "js5": { img: JOHN_SALA, text: "Es él. 'El Asesino de Nochebuena'. John Red.", name: "Tú", next: "js6" },
        "js6": { img: JOHN_SALA, text: "Buscan a un psicópata que se escapó del psiquiátrico de alta seguridad hace dos días.", name: "Tú", next: "js7" },
        "js7": { img: JOHN_SALA, text: "Dijeron que era extremadamente peligroso y manipulador.", name: "Tú", next: "js8" },
        "js8": { img: JOHN_SALA, text: "Dios mío... ¿Por qué yo? ¿Por qué mi casa?", name: "Tú", next: "js9" },
        "js9": { img: JOHN_SALA, text: "Tengo que pensar rápido. Si nota que tengo miedo, estoy muerta.", name: "Tú", next: "jh1" },
        "jh1": { img: JOHN_SALA, text: "Vaya bienvenida. ¿Es así como tratas a Santa cuando viene a visitarte?", name: "John Red", choices: [{ text: "Sé que no eres Santa. ¡Eres John Red!", target: "rc1" }, { text: "Acercarme sonriendo y seguirle el juego.", target: "rs1" }] },

        "rc1": { img: JOHN_SALA, text: "– ¡Déjate de juegos! ¡Sé quién eres! Eres John Red. Te vi en las noticias.", name: "Tú", next: "rc2" },
        "rc2": { img: JOHN_SALA, text: "– ¡Aléjate de mí, ya llamé a la policía!", name: "Tú", next: "jrc1" },
        "jrc1": { img: JOHN_SALA, text: "–...Tsk. Qué aguafiestas. Oh, así que sabes quién soy... Qué pena.", name: "John Red", next: "jrc2" },
        "jrc2": { img: JOHN_SALA, text: "– Odio cuando arruinan la inmersión del personaje.", name: "John Red", next: "ja1" },
        "ja1": { img: JOHN_ASESINO, text: "– Supongo que esto será más rápido de lo que pensé.", name: "John Red", next: "huir1" },
        "huir1": { img: PUERTA_SALIR, text: "– ¡Espera, no-!", name: "Tú", next: "huir2" },
        "huir2": { img: PUERTA_SALIR, text: "Debo salir rápido....", name: "Tú", next: "m3" },
        "m3": { img: PANTALLA_MUERTE, text: "Es inhumano... Se movió más rápido que mi propia sombra.", name: "Tú", next: "m4" },
        "m4": { img: PANTALLA_MUERTE, text: "El cuchillo... quema...", name: "Tú", next: "fm2" },
        "fm2": { img: BG_NEGRO, text: "[FINAL MALO 2: Enfrentarlo no es una Opción]", name: "GAME OVER", restart: true },

        "rs1": { img: JOHN_SALA, text: "Tranquila... Respira. Si corro, me caza como a un animal.", name: "Tú", next: "rs2" },
        "rs2": { img: JOHN_SALA, text: "Tengo que jugar su juego. Tengo que ser más lista.", name: "Tú", next: "rs3" },
        "rs3": { img: JOHN_SALA, text: "Voy a apostarlo todo a una carta: su ego.", name: "Tú", next: "habla1" },
        "habla1": { img: JOHN_SALA, text: "– Vaya... No sabía que Santa Claus sería tan joven... y tan atractivo.", name: "Tú", next: "habla2" },
        "habla2": { img: JOHN_SALA, text: "– Si lo hubiera sabido, te habría dejado la chimenea encendida.", name: "Tú", next: "jr1" },
        "jr1": { img: JOHN_RIE, text: "Jajaja...", name: "John Red", next: "jr2" },
        "jr2": { img: JOHN_RIE, text: "Interesante. Muy interesante. Normalmente la gente grita o corre cuando me ve. Pero tú...", name: "John Red", next: "jr3" },
        "jr3": { img: JOHN_RIE, text: "Tú pareces querer abrir tus regalos antes de tiempo.", name: "John Red", next: "js_preg" },
        "js_preg": { img: JOHN_SALA, text: "Dime... ¿Has sido una chica mala este año?", name: "John Red", choices: [{ text: "He sido una buena chica... merezco algo bueno, ¿verdad?", target: "rbuena1" }, { text: "He sido buena... pero ahora quiero hacer cosas malas.", target: "rmala1" }] },

        "rbuena1": { img: JOHN_SALA, text: "Intento sonreír dulcemente, esperando que la inocencia me salve.", name: "Tú", next: "rb_habla" },
        "rb_habla": { img: JOHN_SALA, text: "– He sido una buena chica todo el año. Merezco algo bueno, ¿verdad?", name: "Tú", next: "jrb1" },
        "jrb1": { img: JOHN_SALA, text: "– ¿Ah, sí? Mmm... Las chicas buenas merecen recompensas especiales.", name: "John Red", next: "jrb2" },
        "jrb2": { img: JOHN_SALA, text: "– Anda, cierra los ojos y extiende las manos. No hagas trampa.", name: "John Red", next: "rb_pensar" },
        "rb_pensar": { img: JOHN_SALA, text: "Gracias a Dios... funcionó. Solo quiere dejarme un regalo y irse. Cierro los ojos, sintiendo un leve alivio", name: "Tú", next: "rb_negro" },
        "rb_negro": { img: BG_NEGRO, text: "Espero...", name: "Tú", sound: "shake", next: "m5" },
        "m5": { img: PANTALLA_MUERTE, text: "– ¡Ah...! ¿Por... qué...?", name: "Tú", next: "m6" },
        "m6": { img: PANTALLA_MUERTE, text: "El dolor es agudo en mi pecho. No puedo respirar", name: "Tú", next: "jrm1" },
        "jrm1": { img: PANTALLA_MUERTE, text: "– ¿Te gusta mi regalo?", name: "John Red", next: "jrm2" },
        "jrm2": { img: PANTALLA_MUERTE, text: "– Verás, preciosa... para un artista como yo, no hay regalo más hermoso que quitar una vida. Feliz Navidad.", name: "John Red", next: "fm3" },
        "fm3": { img: BG_NEGRO, text: "[ FINAL MALO 3: Regalo Equivocado]", name: "GAME OVER", restart: true },

        "rmala1": { img: JOHN_SALA, text: "Lo miro directo a los ojos, desafiante. Si voy a morir, será jugando bajo mis propias reglas.", name: "Tú", next: "rm_habla1" },
        "rm_habla1": { img: JOHN_SALA, text: "– He sido una buena chica...", name: "Tú", next: "rm_accion" },
        "rm_accion": { img: JOHN_SALA, text: "Doy un paso más hacia él, invadiendo su espacio personal.", name: "Tú", next: "rm_habla2" },
        "rm_habla2": { img: JOHN_SALA, text: "– ...pero esta noche quiero hacer cosas malas.", name: "Tú", next: "jrr1" },
        "jrr1": { img: JOHN_RIE, text: "– Jaja... Vaya. Eso no me lo esperaba.", name: "John Red", next: "rm_mano" },
        "rm_mano": { img: JOHN_SALA, text: "Pongo una mano sobre su pecho, justo sobre el borde de su traje de Santa.", name: "Tú", next: "rm_pedir" },
        "rm_pedir": { img: JOHN_SALA, text: "– Ya que estás aquí... ¿Puedo pedir al Santa como regalo esta noche?", name: "Tú", next: "jr_agarre" },
        "jr_agarre": { img: JOHN_RIE, text: "John Red suelta una risa ronca y me agarra de la cintura con fuerza, atrayéndome hacia él.", name: "Narración", next: "js_adv" },
        "js_adv": { img: JOHN_SALA, text: "Cuidado con lo que deseas... Santa no acepta devoluciones.", name: "John Red", next: "jc1" },
        "jc1": { img: JOHN_CUARTO, text: "Ni siquiera sé cómo llegué, pero ahora estoy aquí en mi cuarto, y él me mira desde arriba con esa intensidad depredadora.", name: "Tú", next: "jjc1" },
        "jjc1": { img: JOHN_CUARTO, text: "Bien... Vamos a ver si eres tan valiente como pareces.", name: "John Red", next: "jjc2" },
        "jjc2": { img: JOHN_CUARTO, text: "Olvídate de la Navidad. Esta noche solo existimos tú y yo.", name: "John Red", next: "rm_desafio" },
        "rm_desafio": { img: JOHN_CUARTO, text: "Lo miro de arriba abajo, mordiéndome el labio inferior.", name: "Tú", next: "rm_habla3" },
        "rm_habla3": { img: JOHN_CUARTO, text: "– Ese traje de Santa... debe ser sofocante. ¿No tienes calor, mi querido Claus?", name: "Tú", next: "rm_paso" },
        "rm_paso": { img: JOHN_CUARTO, text: "Doy un paso hacia él, desafiante.", name: "Tú", next: "rm_quiero" },
        "rm_quiero": { img: JOHN_CUARTO, text: "– Te quiero sin nada. Ahora.", name: "Tú", next: "jjc3" },
        "jjc3": { img: JOHN_CUARTO, text: "– Tus deseos son órdenes, princesa.", name: "John Red", next: "jd1" },
        "jd1": { img: JOHN_DESVISTE, text: "Dios mío... Sabía que era fuerte, pero esto...", name: "Tú", next: "jd2" },
        "jd2": { img: JOHN_DESVISTE, text: "Sus abdominales están tan definidos que parecen esculpidos en mármol frío. Cada músculo cuenta una historia de violencia y poder.", name: "Tú", next: "jd3" },
        "jd3": { img: JOHN_DESVISTE, text: "Mi mente grita '¡Corre, es un asesino!', pero mi cuerpo... mi cuerpo solo quiere tocar.", name: "Tú", next: "jd4" },
        "jd4": { img: JOHN_DESVISTE, text: "No puedo creer que en serio vaya a tener algo con este tipo. Estoy loca. Completamente loca.", name: "Tú", next: "jce1" },
        "jce1": { img: JOHN_CERCA, text: "Él rompe la distancia en un segundo. Me agarra de la cintura con sus manos grandes y ásperas, pegándome violentamente contra su cuerpo.", name: "Tú", next: "jce2" },
        "jce2": { img: JOHN_CERCA, text: "El aire se me escapa. Puedo sentirlo todo. Siento su dureza presionando contra mi vientre. Caliente. Firme. Exigente.", name: "Tú", next: "jjce1" },
        "jjce1": { img: JOHN_CERCA, text: "– Dijiste que yo era tu regalo... Pero un regalo no está completo si no lo abres.", name: "John Red", next: "jjce2" },
        "jjce2": { img: JOHN_CERCA, text: "¿Por qué no desenvuelves tú misma... la parte más importante?", name: "John Red", choices: [{ text: "Bajarle los pantalones", target: "op_a1" }, { text: "Que lo haga él", target: "op_b1" }] },

        "op_a1": { img: BG_NEGRO, text: "Mis manos tiemblan, pero no me detengo.", name: "Tú", next: "op_a2" },
        "op_a2": { img: BG_NEGRO, text: "Deslizo mis dedos por la cintura de sus pantalones. Él suelta un gruñido gutural que hace vibrar mi pecho.", name: "Tú", next: "op_a3" },
        "op_a3": { img: BG_NEGRO, text: "Bajo la tela lentamente... Y entonces... lo veo.", name: "Tú", next: "op_a4" },
        "op_a4": { img: BG_NEGRO, text: "Me quedo sin aliento. Liberado de la tela, su miembro se revela ante mis ojos.", name: "Tú", next: "op_a5" },
        "op_a5": { img: BG_NEGRO, text: "Es... masivo. Como un enorme bastón de caramelo, grueso y venoso, que palpita con cada latido de su corazón.", name: "Tú", next: "op_a6" },
        "op_a6": { img: BG_NEGRO, text: "Nunca había visto algo de ese tamaño. Parece casi irreal, un arma hecha para destruir... o para dar un placer insoportable.", name: "Tú", next: "jce3" },
        "jce3": { img: JOHN_CERCA, text: "– Vaya... Santa sí que vino cargado este año.", name: "Tú", next: "empujon" },

        "op_b1": { img: JOHN_CERCA, text: "– Quiero ver. Hazlo tú. Desenvuélvete para mí.", name: "Tú", next: "jjce3" },
        "jjce3": { img: JOHN_CERCA, text: "– Me gusta cuando me miras así. Disfruta la vista.", name: "John Red", next: "op_b2" },
        "op_b2": { img: BG_NEGRO, text: "Él empieza a desabrocharse el cinturón lentamente, manteniendo el contacto visual.", name: "Tú", next: "op_b3" },
        "op_b3": { img: BG_NEGRO, text: "El sonido de la hebilla metálica resuena en la habitación silenciosa.", name: "Tú", next: "op_b4" },
        "op_b4": { img: BG_NEGRO, text: "El pantalón cae, revelando no solo su torso, sino todo. Tiene unas piernas fuertes, musculosas, como columnas capaces de inmovilizar a cualquiera.", name: "Tú", next: "op_b5" },
        "op_b5": { img: BG_NEGRO, text: "Cuando termina de quitarse la ropa interior, mi mirada va directo al centro de atención.", name: "Tú", next: "op_b6" },
        "op_b6": { img: BG_NEGRO, text: "Ahí está. Grueso, pesado y completamente despierto. Se alza con orgullo, una torre de carne que promete partirme en dos. Es una visión imponente. Brutal. Magnífica.", name: "Tú", next: "jce4" },
        "jce4": { img: JOHN_CERCA, text: "–¿Te gusta lo que ves? Parece que estás ansiosa por probar tu juguete nuevo.", name: "John Red", next: "empujon" },

        "empujon": { img: JOHN_CERCA, sound: "shake", text: "Sin previo aviso, me empuja hacia atrás.", name: "Narración", next: "cama1" },
        "cama1": { img: JOHN_CERCA, text: "Caigo sobre el colchón suave, mi cabello se esparce como un abanico sobre las sábanas.", name: "Tú", next: "cama2" },
        "cama2": { img: JOHN_CERCA, text: "Él se inclina sobre mí, como un depredador acorralando a su presa.", name: "Tú", next: "jjce4" },
        "jjce4": { img: JOHN_CERCA, text: "– Una piel tan suave... merece ser cubrida de besos.", name: "John Red", next: "jjce5" },
        "jjce5": { img: JOHN_CERCA, text: "– Esa bata estorba. Quiero ver mi regalo completo.", name: "John Red", choices: [{ text: "Quitarme la ropa yo misma.", target: "op_a_ropa" }, { text: "Que me la quite él.", target: "op_b_ropa" }] },

        // ROPA OPCION A
        "op_a_ropa": { img: SANTA_CERCA, text: "– Está bien... Mira y sufre.", name: "Tú", next: "opa2" },
        "opa2": { img: BG_NEGRO, text: "Deslizo levanto mi bata por mi cabeza y la lanzo a un lado, luego deslizo mis medias y bragas lentamente.", name: "Tú", next: "opa3" },
        "opa3": { img: BG_NEGRO, text: "Quedo totalmente expuesta ante él.", name: "Tú", next: "opa4" },
        "opa4": { img: BG_NEGRO, text: "No dice nada. Solo respira fuerte.", name: "Tú", sound: "shake", next: "opa5" },
        "opa5": { img: BG_NEGRO, text: "Antes de que pueda reaccionar, me empuja hacia el colchón y se coloca entre mis piernas. No hay preámbulos. Su paciencia se agotó.", name: "Tú", next: "jjopa1" },
        "jjopa1": { img: BG_NEGRO, text: "– Ya has demorado demasiado.", name: "John Red", next: "opa6" },
        "opa6": { img: BG_NEGRO, text: "Agarra mis muslos y los separa con fuerza, abriéndome para él. Baja la cabeza de golpe y siento su boca caliente contra mi piel.", name: "Tú", next: "opa7" },
        "opa7": { img: BG_NEGRO, text: "– ¡Ah...!", name: "Tú", next: "opa8" },
        "opa8": { img: BG_NEGRO, text: "Su lengua es áspera, decidida. Me lame con fuerza, como un animal hambriento devorando su presa.", name: "Tú", next: "opa9" },
        "opa9": { img: BG_NEGRO, text: "Mis dedos se enredan en su cabello blanco mientras él me hace ver las estrellas con cada movimiento de su lengua.", name: "Tú", next: "oral_comun" },

        // ROPA OPCION B
        "op_b_ropa": { img: SANTA_CERCA, text: "Le extiendo los brazos, invitándolo.", name: "Tú", next: "opb2" },
        "opb2": { img: SANTA_CERCA, text: "– Tú eres el que tiene hambre... Desenvuélveme tú.", name: "Tú", next: "jjopb1" },
        "jjopb1": { img: SANTA_CERCA, text: "– Me gusta cuando cooperas.", name: "John Red", next: "mano1" },
        "mano1": { img: BESO_MANO, text: "Se acerca despacio. Toma mi mano y deposita un beso en mis nudillos, sin dejar de mirarme a los ojos.", name: "Tú", next: "mano2" },
        "mano2": { img: BESO_MANO, text: "Es un gesto casi caballeroso... si no fuera por la oscuridad en su mirada.", name: "Tú", next: "opb3" },
        "opb3": { img: BG_NEGRO, text: "Sus dedos bajan los tirantes de mi bata. La tela se desliza, revelando mi piel centímetro a centímetro. Besa mi cuello, mi hombro... bajando lento, tortuosamente lento.", name: "Tú", next: "lp1" },
        "lp1": { img: LEVANTA_PIERNA, text: "Toma mi pierna y la levanta en el aire. Siento su agarre firme en mi tobillo. Me domina por completo.", name: "Tú", next: "lp2" },
        "lp2": { img: LEVANTA_PIERNA, text: "Con la otra mano, retira mis medias, dejando mi piel desnuda y suave expuesta al frío de la habitación... y al calor de su boca.", name: "Tú", next: "bp1" },
        "bp1": { img: BESO_PIERNA, text: "Besa mi tobillo. Un beso húmedo y sonoro que me hace temblar.", name: "Tú", next: "opb4" },
        "opb4": { img: BG_NEGRO, text: "Sigue subiendo dando besos y mordidas en toda mi pierna hasta llegar a mi muslo interno.", name: "Tú", next: "opb5" },
        "opb5": { img: BG_NEGRO, text: "Está tan cerca de mi centro... Puedo sentir su aliento caliente ahí abajo.", name: "Tú", next: "opb6" },
        "opb6": { img: BG_NEGRO, text: "Desliza mis bragas hacia abajo y las tira a un lado.", name: "Tú", next: "opb7" },
        "opb7": { img: BG_NEGRO, text: "Finalmente, separa mis piernas y se acomoda en medio. Me mira como si fuera lo más delicioso que ha visto en su vida.", name: "Tú", next: "jce5" },
        "jce5": { img: SANTA_CERCA, text: "– Vaya... Qué vista más hermosa. Parece que tendré que comerme este dulce pastel de Navidad yo solo.", name: "John Red", next: "opb8" },
        "opb8": { img: BG_NEGRO, text: "Hunde su rostro en mi intimidad.", name: "Tú", next: "opb9" },
        "opb9": { img: BG_NEGRO, text: "– ¡Oh, Dios...!", name: "Tú", next: "oral_comun" },

        // ORAL COMUN
        "oral_comun": { img: BG_NEGRO, text: "Su lengua traza círculos perfectos sobre mi punto más sensible, haciéndome jadear.", name: "Tú", next: "oc2" },
        "oc2": { img: BG_NEGRO, text: "Sabe exactamente qué hacer. Me prueba, me saborea con largas lamidas, alternando presión y suavidad.", name: "Tú", next: "oc3" },
        "oc3": { img: BG_NEGRO, text: "Mientras su boca trabaja ahí abajo, sus manos grandes suben por mi cuerpo. Sus palmas cubren mis pechos, amasándolos con posesión.", name: "Tú", next: "oc4" },
        "oc4": { img: BG_NEGRO, text: "Sus pulgares frotan mis cumbres endurecidas, pellizcando suavemente al mismo ritmo que su lengua se mueve.", name: "Tú", next: "oc5" },
        "oc5": { img: BG_NEGRO, text: "La sensación es doble. Placer arriba y abajo.", name: "Tú", next: "oc6" },
        "oc6": { img: BG_NEGRO, text: "Me estoy volviendo loca. Me va a hacer gritar.", name: "Tú", next: "oc7" },
        "oc7": { img: BG_NEGRO, text: "Siento que estoy a punto de romperme. El calor se concentra en un punto incandescente, una presión dulce y urgente que me empuja hacia el abismo.", name: "Tú", next: "oc8" },
        "oc8": { img: BG_NEGRO, text: "Estoy tan cerca... tan cerca de tocar el cielo.", name: "Tú", next: "oc9" },
        "oc9": { img: BG_NEGRO, text: "Pero de golpe, todo se detiene.", name: "Tú", next: "oc10" },
        "oc10": { img: BG_NEGRO, text: "La ausencia de su calor es un shock frío. Abro los ojos, aturdida y jadeante, buscándolo.", name: "Tú", next: "jce6" },
        "jce6": { img: SANTA_CERCA, text: "Él levanta la cabeza lentamente. Me mira desde abajo con esos ojos depredadores.", name: "Tú", next: "jce7" },
        "jce7": { img: SANTA_CERCA, text: "Sus labios están húmedos, rojos e hinchados.", name: "Tú", next: "jce8" },
        "jce8": { img: SANTA_CERCA, text: "Pasa su lengua lentamente sobre ellos, saboreándome con una calma que contrasta con mi respiración agitada.", name: "Narración", next: "preg_para" },
        "preg_para": { img: SANTA_CERCA, text: "—¿Por qué paraste?", name: "Tú", next: "preg_para2" },
        "preg_para2": { img: SANTA_CERCA, text: "Mi voz sale como un súplica rota, casi un gemido.", name: "Tú", next: "negro_final1" },
        "negro_final1": { img: BG_NEGRO, text: "Él no responde con palabras, no todavía. Se arrastra sobre mí, subiendo por la cama como una sombra que cubre la luz.", name: "Tú", next: "nf2" },
        "nf2": { img: BG_NEGRO, text: "Siento su peso, su calor radiante dominando cada centímetro de mi espacio.", name: "Tú", next: "nf3" },
        "nf3": { img: BG_NEGRO, text: "Se acomoda con firmeza entre mis piernas abiertas, encajando sus caderas contra las mías. La fricción de su deseo contra mi entrada me hace arquear la espalda instintivamente.", name: "Tú", next: "nf4" },
        "nf4": { img: BG_NEGRO, text: "Me mira directo a los ojos, con una intensidad que quema más que el fuego.", name: "Tú", next: "jjnf1" },
        "jjnf1": { img: BG_NEGRO, text: "– Ya no aguanto más... necesito estar dentro de ti.", name: "John Red", next: "nf5" },
        "nf5": { img: BG_NEGRO, text: "Su mano baja para guiarme, alineando nuestros cuerpos en una perfecta y peligrosa sincronía.", name: "Tú", next: "nf6" },
        "nf6": { img: BG_NEGRO, text: "El aire se vuelve denso, cargado de una electricidad estática que eriza mi piel. Ya no hay vuelta atrás.", name: "Tú", next: "nf7" },
            "nf7": { img: BG_NEGRO, text: "De un impulso, acorta la distancia y captura mi boca. Su beso es salvaje. Siento su lengua invadiendo mi boca, probando cada rincón, mordiendo mi labio inferior con una posesividad que me hace gemir.", name: "Tú", next: "nf8" },
        "nf8": { img: BG_NEGRO, text: "Enrosco mis brazos alrededor de su cuello y mis piernas en su cadera, buscando más fricción.", name: "Tú", next: "nf9" },
        "nf9": { img: BG_NEGRO, text: "Siento la punta de su deseo presionando mi entrada, caliente y palpitante.", name: "Tú", next: "nf10" },
        "nf10": { img: BG_NEGRO, text: "Y entonces... empuja.", name: "Tú", next: "nf11" },
        "nf11": { img: BG_NEGRO, text: "– ¡Ahhh! Dios mío...", name: "Tú", next: "nf12" },
        "nf12": { img: BG_NEGRO, text: "Entra de una sola estocada, llenándome por completo. Me siento estirada, llena, ocupada por su tamaño imponente.", name: "Tú", next: "nf13" },
        "nf13": { img: BG_NEGRO, text: "Es una sensación abrumadora. Siento cómo roza cada pared interna, reclamando mi cuerpo como si fuera su territorio.", name: "Tú", next: "jjnf2" },
        "jjnf2": { img: BG_NEGRO, text: "– Estás tan apretada... Joder, eres perfecta.", name: "John Red", choices: [{ text: "Dejar que él siga.", target: "op_a_final" }, { text: "Empujarlo y tomar el control.", target: "op_b_final" }] },

        // OPCION A FINAL
        "op_a_final": { img: BG_NEGRO, text: "Muerde mi cuello, marcando mi piel mientras sus caderas golpean contra mis nalgas.", name: "Tú", next: "oaf2" },
        "oaf2": { img: BG_NEGRO, text: "El sonido de nuestra piel chocando llena la habitación.", name: "Tú", next: "oaf3" },
        "oaf3": { img: BG_NEGRO, text: "Su mano en mi centro no se detiene, me lleva al borde de la locura.", name: "Tú", next: "oaf4" },
        "oaf4": { img: BG_NEGRO, text: "Me da una nalgada sonora que me hace gritar, y con tres embestidas finales brutales...", name: "Tú", next: "oaf5" },
        "oaf5": { img: BG_NEGRO, text: "Nos deshacemos juntos en la oscuridad.", name: "Tú", next: "final_bueno_msg" },

        // OPCION B FINAL
        "op_b_final": { img: BG_NEGRO, text: "Pongo las manos en su pecho y lo empujo hacia atrás con fuerza.", name: "Tú", next: "obf2" },
        "obf2": { img: BG_NEGRO, text: "– Espera. Parece que quieres llevarte todo el crédito.", name: "Tú", next: "ca1" },
        "ca1": { img: CAMA_ABAJO, text: "– Vaya... Parece que quieres tomar el control, ¿eh?", name: "John Red", next: "ca2" },
        "ca2": { img: CAMA_ABAJO, text: "Me subo a horcajadas sobre él.", name: "Tú", next: "ca3" },
        "ca3": { img: CAMA_ABAJO, text: "– Sí. Quiero verte desde arriba.", name: "Tú", next: "ca4" },
        "ca4": { img: CAMA_ABAJO, text: "Me acomodo sobre sus caderas y bajo lentamente, dejándolo entrar en mí centímetro a centímetro.", name: "Tú", next: "ca5" },
        "ca5": { img: CAMA_ABAJO, text: "Desde este ángulo, lo siento mucho más profundo. Toca lugares que no sabía que existían, rozando casi mi útero.", name: "Tú", effect: "bob", next: "ca6" },
        "ca6": { img: CAMA_ABAJO, text: "Empiezo a moverme. Lento. En círculos. Es una tortura deliciosa.", name: "Tú", next: "ca_negro" },
        "ca_negro": { img: BG_NEGRO, text: "– Joder...", name: "John Red", next: "can2" },
        "can2": { img: BG_NEGRO, text: "Él gime roncamente y echa la cabeza hacia atrás.", name: "Tú", next: "can3" },
        "can3": { img: BG_NEGRO, text: "Me inclino hacia adelante y muerdo su cuello. Él agarra mi trasero con sus manos grandes.", name: "Tú", next: "can4" },
        "can4": { img: BG_NEGRO, text: "Me amasa, me nalguea, dejando sus marcas en mi piel. Aumento el ritmo. Subo y bajo, cabalgándolo con desesperación.", name: "Tú", next: "can5" },
        "can5": { img: BG_NEGRO, text: "Estoy cerca... estoy tan cerca...", name: "Tú", next: "can6" },
        "can6": { img: BG_NEGRO, text: "Pero de repente...", name: "Tú", sound: "shake", next: "ca7" },
        "ca7": { img: CAMA_ABAJO, text: "– ¡Ah! ¿Qué...?", name: "Tú", next: "ca8" },
        "ca8": { img: CAMA_ABAJO, text: "Me detiene en el aire. Solo siento el roce de su punta en mi entrada, pero no está dentro. Me ha dejado vacía de golpe.", name: "Tú", next: "ca9" },
        "ca9": { img: CAMA_ABAJO, text: "–¿Qué haces? ¡Estaba a punto de llegar!", name: "Tú", next: "jjca1" },
        "jjca1": { img: CAMA_ABAJO, text: "– ¿Ya estabas en el borde? Mmm... No tan rápido, princesa. Suplícame. Suplica por ella.", name: "John Red", next: "ca10" },
        "ca10": { img: CAMA_ABAJO, text: "Mis mejillas arden. Mi cuerpo palpita, necesitándolo desesperadamente.", name: "Tú", next: "ca11" },
        "ca11": { img: CAMA_ABAJO, text: "Ugh, sigue siendo malo incluso ahora... pero no puedo parar.", name: "Tú", next: "ca12" },
        "ca12": { img: CAMA_ABAJO, text: "Él frota la punta contra mi centro, provocándome, haciéndome temblar.", name: "Tú", next: "ca13" },
        "ca13": { img: CAMA_ABAJO, text: "– Por favor... Santa Claus... Mételo de nuevo... Por favor.", name: "Tú", next: "jjca2" },
        "jjca2": { img: CAMA_ABAJO, text: "– Buena chica.", name: "John Red", next: "ca_negro2" },
        "ca_negro2": { img: BG_NEGRO, text: "Suelta mis caderas y caigo de golpe sobre su miembro. Me arqueo ante la sensación intensa.", name: "Tú", next: "can2_2" },
        "can2_2": { img: BG_NEGRO, text: "Me llena tan profundo que me corta la respiración. Un gemido ensordecedor se me escapa", name: "Tú", next: "can2_3" },
        "can2_3": { img: BG_NEGRO, text: "– ¡Angggh!", name: "Tú", next: "can2_4" },
        "can2_4": { img: BG_NEGRO, text: "Sin darme tiempo a recuperarme, agarra mis nalgas y empieza a embestir desde abajo con rapidez.", name: "Tú", next: "can2_5" },
        "can2_5": { img: BG_NEGRO, text: "Caigo sobre su pecho, gimiendo sin control. Él captura mi boca. Su lengua juega con la mía, pero con una violencia feroz, devorándome.", name: "Tú", next: "jjca3" },
        "jjca3": { img: BG_NEGRO, text: "– Uff... ya estabas apretada, pero ahora lo estás más... Vas a partirme en dos si sigues apretando así.", name: "John Red", next: "can2_6" },
        "can2_6": { img: BG_NEGRO, text: "– ¡No puedes decir algo así... cuando lo tuyo es más grande que el promedio! ¡Ahh! ¡Ahh!", name: "Tú", next: "jjca4" },
        "jjca4": { img: BG_NEGRO, text: "– Cállate y recíbelo todo. Te voy a llenar ahora mismo de mi...", name: "John Red", next: "can2_7" },
        "can2_7": { img: BG_NEGRO, text: "Con una última embestida que parece tocar mi alma, siento su cuerpo tensarse.", name: "Tú", next: "can2_8" },
        "can2_8": { img: BG_NEGRO, text: "Siento su semilla caliente inundando mi interior en oleadas. Mis piernas tiemblan, perdiendo toda fuerza.", name: "Tú", next: "can2_9" },
        "can2_9": { img: BG_NEGRO, text: "Me deshago junto con él, mi mente en blanco, flotando en puro placer.", name: "Tú", next: "can2_10" },
        "can2_10": { img: BG_NEGRO, text: "Mi respiración se va calmando poco a poco.", name: "Tú", next: "can2_11" },
        "can2_11": { img: BG_NEGRO, text: "El silencio vuelve a la habitación, pero ya no se siente solitario. Siento, ya medio adormilada, cómo él besa mi cuello con una ternura extraña.", name: "Tú", next: "jjca5" },
        "jjca5": { img: BG_NEGRO, text: "– Descansa ahora... mi chica mala. Feliz Navidad.", name: "John Red", next: "final_bueno_msg" },

        // FINAL BUENO COMUN
        "final_bueno_msg": { img: BG_NEGRO, text: "✨ FINAL BUENO: FELIZ NAVIDAD ✨", name: "Sistema", choices: [{ text: "Terminar Juego", target: "fin_juego" }, { text: "Ver Extra Especial", target: "extra1" }] },
        "fin_juego": { img: BG_NEGRO, text: "Gracias por jugar.", name: "Sistema", next: "creditos" },

        // EXTRA ESPECIAL
        "extra1": { img: CUARTO_REVUELTO, text: "– Mmm...", name: "Tú", next: "ex2" },
        "ex2": { img: CUARTO_REVUELTO, text: "Aún dormida, palmeo el lado de la cama buscando calor.", name: "Tú", next: "ex3" },
        "ex3": { img: CUARTO_REVUELTO, text: "Siento el vacío. Abro los ojos de golpe.", name: "Tú", next: "ex4" },
        "ex4": { img: CUARTO_REVUELTO, text: "– ¿Fue... fue un sueño? La cama está revuelta... pero pude ser yo anoche al moverme.", name: "Tú", next: "ex5" },
        "ex5": { img: CUARTO_REVUELTO, text: "Intento levantarme.", name: "Tú", sound: "shake", next: "ex6" },
        "ex6": { img: CUARTO_REVUELTO, text: "– ¡Ah!", name: "Tú", next: "ex7" },
        "ex7": { img: CUARTO_REVUELTO, text: "Una punzada de dolor recorre mi cadera y la parte interna de mis muslos", name: "Tú", next: "ex8" },
        "ex8": { img: CUARTO_REVUELTO, text: "¡No... definitivamente no fue un sueño! Ese dolor... esa sensación de plenitud... Dios mío.", name: "Tú", next: "ex9" },
        "ex9": { img: CUARTO_REVUELTO, text: "Menos mal que tomo pastillas anticonceptivas por mi ciclo irregular.", name: "Tú", next: "ex10" },
        "ex10": { img: CUARTO_REVUELTO, text: "Me giro hacia la mesita de noche buscando mi teléfono, pero encuentro algo más.", name: "Tú", next: "ex11" },
        "ex11": { img: CUARTO_REVUELTO, text: "– ¿Umm? ¿Una nota?", name: "Tú", next: "nota1" },
        
        // CORRECCIÓN 1: Usamos la variable correcta NOTA_FINAL (asegúrate que arriba esté definida así)
        "nota1": { img: NOTA_FINAL, text: "\"Espero que no me olvides, espera mi regalo la próxima navidad. Tu querido Santa Claus.\"", name: "Nota", next: "ne1" },
        
        "ne1": { img: BG_NEGRO, text: "Dejo caer la nota, temblando. Tiene que ser una broma...", name: "Tú", next: "ne2" },
        "ne2": { img: BG_NEGRO, text: "Pensé que me perdonaría la vida pasando la noche con él... Pensé que huiría y no lo vería nunca más.", name: "Tú", next: "ne3" },
        "ne3": { img: BG_NEGRO, text: "Pero dice... ¿La próxima Navidad? ¿Qué será de mí? Una parte de mí tiene miedo.", name: "Tú", next: "ne4" },
        "ne4": { img: BG_NEGRO, text: "Debería llamar a la policía ahora mismo. Pero otra parte...", name: "Tú", next: "ne5" },
        "ne5": { img: BG_NEGRO, text: "Me toco los labios, recordando sus besos.", name: "Tú", next: "ne6" },
        "ne6": { img: BG_NEGRO, text: "..Sé que lo de anoche será imposible de olvidar.", name: "Tú", next: "fin_extra" },
        "fin_extra": { img: BG_NEGRO, text: "FIN DEL EPÍLOGO", name: "Sistema", next: "creditos" },

        // CORRECCIÓN 2: "creditos" ahora está DENTRO de la historia (antes de la llave de cierre)
        "creditos": { 
            img: BG_NEGRO, 
            text: "✨ CRÉDITOS ✨\n\n\nAutora: Aria\n\n<Sueños entre Almohadas>\n\n\nGracias por leer.",
            name: " ", 
            restart: true 
        }
    }; // <--- AQUÍ se cierra la historia correctamente.

    /* === MOTOR LÓGICO === */
    let playerName = "Tú";
    const elements = {
        startScreen: document.getElementById("start-screen"),
        nameInput: document.getElementById("player-name-input"),
        startBtn: document.getElementById("start-btn"),
        sceneBack: document.getElementById("scene-layer-back"),
        sceneFront: document.getElementById("scene-layer-front"),
        flashOverlay: document.getElementById("flash-overlay"),
        textArea: document.getElementById("text-area"),
        textName: document.getElementById("char-name"),
        textDialog: document.getElementById("dialogue-text"),
        nextBtn: document.getElementById("next-btn"),
        choicesArea: document.getElementById("choices-area")
    };

    elements.startBtn.onclick = () => {
        const inputName = elements.nameInput.value.trim();
        if(inputName.length > 0) playerName = inputName;
        elements.startScreen.classList.add("hidden");
        elements.textArea.classList.remove("hidden");
        setLayerImage(elements.sceneBack, story["start"].img);
        renderNode("start");
    };

    function setLayerImage(layer, imgSource) {
        if (imgSource.startsWith("#")) { layer.style.backgroundImage = "none"; layer.style.backgroundColor = imgSource; }
              else { layer.style.backgroundColor = "#000"; layer.style.backgroundImage = "url('" + imgSource + "')"; }

    function renderNode(nodeId) {
        const node = story[nodeId];
        elements.nextBtn.classList.remove("hidden");
        elements.choicesArea.classList.add("hidden");
        elements.choicesArea.innerHTML = "";
        elements.flashOverlay.classList.remove("flash-active");
        elements.textArea.classList.remove("bobbing");

        if (node.img) {
            setLayerImage(elements.sceneFront, node.img);
            setTimeout(() => { elements.sceneFront.classList.add("fade-in"); }, 50);
            setTimeout(() => { setLayerImage(elements.sceneBack, node.img); elements.sceneFront.classList.remove("fade-in"); }, 650);
        }

        let displayName = node.name === "Tú" ? playerName : node.name;
        elements.textName.textContent = displayName;
        
        // CORRECCIÓN 3: Usamos innerText para que respeten los espacios y saltos de línea en los créditos
        elements.textDialog.innerText = node.text || "...";

        if (node.sound === "shake") { document.body.classList.add("shake"); setTimeout(() => document.body.classList.remove("shake"), 500); }
        if (node.effect === "flash") { elements.flashOverlay.classList.add("flash-active"); setTimeout(() => elements.flashOverlay.classList.remove("flash-active"), 200); }
        if (node.effect === "bob") { elements.textArea.classList.add("bobbing"); }

        if (node.choices) {
            elements.nextBtn.classList.add("hidden");
            elements.choicesArea.classList.remove("hidden");
            node.choices.forEach(choice => {
                const btn = document.createElement("button");
                btn.className = "btn";
                btn.textContent = choice.text;
                btn.onclick = () => renderNode(choice.target);
                elements.choicesArea.appendChild(btn);
            });
        } else if (node.restart) {
            elements.nextBtn.onclick = () => location.reload();
            elements.nextBtn.textContent = "↻ Reiniciar";
        } else {
            elements.nextBtn.onclick = () => renderNode(node.next);
            elements.nextBtn.textContent = "▼";
        }
    }
</script>
</body>
</html>
